# Embedding Generation for Vector Search

This directory contains the implementation for generating embeddings for blog posts using OpenAI's `text-embedding-3-small` model.

## Overview

The embedding generation system provides:
- Vector embeddings (1536 dimensions) for semantic search
- API endpoint for generating embeddings
- CLI script for batch processing
- Integration with Supabase pgvector

## Database Setup

The pgvector extension is enabled via migration `20260216015500_enable_pgvector_and_add_embedding.sql`:

- Enables PostgreSQL pgvector extension
- Adds `embedding` column (`vector(1536)`) to `posts` table
- Creates IVFFlat index for efficient similarity search

## Architecture

### Embedding Generation

Embeddings are generated by combining:
1. **Title** (weighted 2x for importance)
2. **Excerpt** (optional, or extracted from content)
3. **Full content** (extracted from Portable Text format)

This approach provides comprehensive semantic representation for search.

### OpenAI Integration

- Model: `text-embedding-3-small`
- Dimensions: 1536
- API: OpenAI Embeddings API
- Gateway: Can be configured to use Vercel AI Gateway (optional)

## Usage

### Environment Variables

```bash
# Required for embedding generation
OPENAI_API_KEY=your-openai-api-key

# Supabase configuration (already required)
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

### API Endpoint

**POST** `/api/embeddings/generate`

Generate embeddings via HTTP API (requires authentication).

#### Request Body

```json
{
  "postId": "uuid",  // Optional: Generate for specific post
  "all": true        // Optional: Generate for all posts without embeddings
}
```

#### Example Response

```json
{
  "total": 10,
  "successCount": 10,
  "failureCount": 0,
  "results": [
    {
      "id": "post-uuid",
      "success": true
    }
  ]
}
```

#### Example Usage

```bash
# Generate embedding for a specific post
curl -X POST http://localhost:3001/api/embeddings/generate \
  -H "Content-Type: application/json" \
  -d '{"postId": "your-post-id"}'

# Generate embeddings for all posts
curl -X POST http://localhost:3001/api/embeddings/generate \
  -H "Content-Type: application/json" \
  -d '{"all": true}'
```

### CLI Script

For batch processing or initial setup:

```bash
# Generate embeddings for all posts without embeddings
pnpm tsx scripts/generate-embeddings.ts --all

# Generate embedding for a specific post
pnpm tsx scripts/generate-embeddings.ts --post-id=your-post-id
```

## Implementation Details

### Portable Text Extraction

The system extracts text from Portable Text JSON format:

```typescript
// Extract plain text from nested Portable Text structure
function extractTextFromPortableText(content: Json): string {
  // Traverses blocks and children to extract text nodes
  // Returns concatenated plain text for embedding
}
```

### Embedding Storage

Embeddings are stored as PostgreSQL `vector(1536)` type:

```sql
-- Update post with embedding
UPDATE posts 
SET embedding = '[0.123, -0.456, ...]'::vector(1536)
WHERE id = 'post-id';
```

### Index Configuration

IVFFlat index for fast similarity search:

```sql
CREATE INDEX posts_embedding_idx 
  ON posts 
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 10);
```

**Note**: The `lists` parameter should be adjusted as the dataset grows:
- Recommended: `rows / 1000`
- Current: 10 (suitable for small datasets)
- Update with: `REINDEX INDEX posts_embedding_idx;`

## Future Enhancements

1. **Similarity Search API**: Implement endpoint for finding similar posts
2. **Automatic Regeneration**: Trigger embedding updates when posts are modified
3. **Batch Processing**: Improve performance for large-scale operations
4. **Vercel AI Gateway**: Add configuration for using Vercel AI Gateway
5. **Embedding Cache**: Cache embeddings to reduce API costs

## Cost Considerations

- Model: `text-embedding-3-small`
- Cost: ~$0.00002 per 1K tokens
- Average post: ~500-2000 tokens
- Estimated cost per post: $0.00001-$0.00004

For 1000 posts: ~$0.01-$0.04

## References

- [Supabase pgvector Documentation](https://supabase.com/docs/guides/database/extensions/pgvector)
- [OpenAI Embeddings API](https://platform.openai.com/docs/guides/embeddings)
- [Vercel AI Gateway Documentation](https://vercel.com/docs/ai-gateway)
