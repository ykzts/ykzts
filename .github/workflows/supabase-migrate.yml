name: Supabase Migration

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'supabase/migrations/**'
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'

permissions:
  contents: read
  pull-requests: write

env:
  # renovate: datasource=github-releases depName=supabase/cli
  SUPABASE_VERSION: 2.75.0

# Prevent concurrent migrations to the same environment
concurrency:
  group: supabase-migration-${{ github.event_name == 'push' && 'production' || format('pr-{0}', github.event.pull_request.number) }}
  cancel-in-progress: false

jobs:
  check:
    name: Dry-run migration check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@c62d8d88c1018e4da540d7f2ef16361c77916c73 # v1.6.0
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: Run migration dry-run
        id: dry-run
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          # Link to production project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          
          # Run dry-run and capture output
          echo "Running migration dry-run..."
          if supabase db push --dry-run 2>&1 | tee dry-run-output.txt; then
            echo "dry_run_success=true" >> $GITHUB_OUTPUT
          else
            echo "dry_run_success=false" >> $GITHUB_OUTPUT
          fi
          
          # Save output for PR comment
          echo 'DRY_RUN_OUTPUT<<EOF' >> $GITHUB_ENV
          cat dry-run-output.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Comment on PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const dryRunSuccess = ${{ steps.dry-run.outputs.dry_run_success }};
            const dryRunOutput = process.env.DRY_RUN_OUTPUT;
            
            const body = `## üîç Supabase Migration Dry-run Results
            
            ${dryRunSuccess ? '‚úÖ Dry-run completed successfully' : '‚ùå Dry-run failed'}
            
            <details>
            <summary>View dry-run output</summary>
            
            \`\`\`
            ${dryRunOutput}
            \`\`\`
            
            </details>
            
            ${dryRunSuccess ? 
              '> ‚ú® The migration can be safely applied to production after merging.' : 
              '> ‚ö†Ô∏è Please review and fix the migration errors before merging.'
            }
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('üîç Supabase Migration Dry-run Results')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Fail if dry-run failed
        if: steps.dry-run.outputs.dry_run_success != 'true'
        run: |
          echo "Dry-run failed. Please fix the migration errors."
          exit 1

  deploy:
    name: Apply migration to production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@c62d8d88c1018e4da540d7f2ef16361c77916c73 # v1.6.0
        with:
          version: ${{ env.SUPABASE_VERSION }}

      - name: Apply migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          # Link to production project
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          
          # Apply migrations (idempotent - skips already applied migrations)
          echo "Applying migrations to production..."
          supabase db push
          
          echo "‚úÖ Migrations applied successfully!"
